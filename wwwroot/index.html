<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <!-- https://developers.google.com/web/updates/2018/07/pwacompat -->
    <script async src="https://unpkg.com/pwacompat" crossorigin="anonymous"></script>
    <title>Document</title>
    <style>
        #iOSCallToAction {
            font-style: italic;
            padding: 5px;
            border: 1px solid black;
            background-color: silver;
        }
        @media not all and (display-mode: standalone) {

            /* not launched as an installed PWA */
            body {
                background-color: red;
            }
        }

        @media all and (display-mode: standalone) {

            /* launched as an installed PWA */
            body {
                background-color: yellow;
            }
        }
    </style>
</head>

<body>
    <h1>Index</h1>

    <p id="installButton" style="display: none;"><button>Install</button></p>
    <p id="iOSCallToAction" style="display: none;">Install this webapp on your iPhone: tap share and then Add to homescreen</p>

    <div id="log"></div>

    <script>

        function log(message) {
            console.log(message);
            let p = document.createElement('p');
            p.textContent = message;
            document.getElementById('log').appendChild(p);
        }

        let deferredPrompt;

        if ('onbeforeinstallprompt' in window) {
            // https://developer.mozilla.org/en-US/docs/Web/API/Window/onbeforeinstallprompt
            window.addEventListener('beforeinstallprompt', e => {
                log('beforeinstallprompt has been fired');
                // Prevents immediate prompt display
                e.preventDefault();
                // https://developer.mozilla.org/en-US/docs/Web/API/BeforeInstallPromptEvent
                log('platforms ' + e.platforms.join(','));
                // Stash the event so it can be triggered later.
                deferredPrompt = e;
                // Update UI notify the user they can install the PWA
                installButton.style.display = 'block';
            });
        } else {
            log('onbeforeinstallprompt is not supported');
        }

        var installButton = document.getElementById('installButton');

        installButton.addEventListener('click', async (e) => {
            // https://developer.mozilla.org/en-US/docs/Web/API/BeforeInstallPromptEvent
            deferredPrompt.prompt();
            let result = await deferredPrompt.userChoice;
            if (result.outcome === 'accepted') {
                log('User accepted the install prompt');
            } else {
                log('User dismissed the install prompt');
            }
        });

        // https://developer.mozilla.org/en-US/docs/Web/API/Window/onappinstalled
        // Is dispatched once the web application is successfully installed
        if ('onappinstalled' in window) {
            window.addEventListener('appinstalled', e => {
                log('app is installed');
                installButton.style.display = 'none';
            });
        } else {
            log('onappinstalled is not supported');
        }

        window.addEventListener('load', () => {
            if (navigator.standalone) {
                log('Launched: Installed (iOS)');
            } else if (matchMedia('(display-mode: standalone)').matches) {
                log('Launched: Installed');
            } else {
                log('Launched: Browser Tab');
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then((reg) => {
                    log('SW registered!');
                    // self.addEventListener('install', event => {
                    // });
                    // self.addEventListener('activate', event => {
                    // });
                    // self.addEventListener('fetch', function (event) {
                    //     console.log('fetch', event.request.url);
                    // });                
                }).catch((error) => {
                    log('Boo!', error);
                });
        } else {
            log('serviceWorker is not supported');
        }

        // https://www.netguru.com/codestories/few-tips-that-will-make-your-pwa-on-ios-feel-like-native
        // Detects if device is on iOS 
        const isIos = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }

        log('isIos: ' + isIos());

        // Detects if device is in standalone mode
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
        log('isInStandaloneMode: ' + isInStandaloneMode());

        // Checks if should display install popup notification:
        if (isIos() && !isInStandaloneMode()) {
            document.getElementById('iOSCallToAction').style.display = 'block';
        }
    </script>
</body>

</html>