<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <!-- https://developers.google.com/web/updates/2018/07/pwacompat -->
    <script async src="https://unpkg.com/pwacompat" crossorigin="anonymous"></script>
    <title>Document</title>
    <style>
        #ios_call_to_action {
            font-style: italic;
            padding: 5px;
            border: 1px solid black;
            background-color: silver;
        }

        @media not all and (display-mode: standalone) {

            /* not launched as an installed PWA */
            body {
                background-color: red;
            }
        }

        @media all and (display-mode: standalone) {

            /* launched as an installed PWA */
            body {
                background-color: yellow;
            }
        }
    </style>
</head>

<body>
    <h1>Index</h1>

    <p id="install_button" style="display: none;"><button>Install</button></p>
    <p id="ios_call_to_action" style="display: none;">Install this webapp on your iPhone: tap share and then Add to
        homescreen</p>

    <h2>Web Worker</h2>
    <button id="web_worker_create">Create web worker</button>
    <button id="web_worker_send_message">Send message web worker</button>
    <button id="web_worker_throw_error">Throw error web worker</button>
    <button id="web_worker_terminate">Terminate web worker</button>
    <button id="web_worker_close">Close web worker from inside</button>

    <h2>Shared Web Worker</h2>
    <button id="shared_web_worker_create">Create shared web worker</button>
    <button id="shared_web_worker_send_message">Send message shared web worker</button>

    <h2>Nofication</h2>
    <button onclick="notifyMe()">Notify me!</button>
    <button onclick="notifyMeWithSimpleCode()">Notify me with simple code!</button>

    <div id="log"></div>

    <script>

        function log(message) {
            console.log(message);
            let p = document.createElement('p');
            p.textContent = message;
            document.getElementById('log').appendChild(p);
        }

        let deferredPrompt;

        if ('onbeforeinstallprompt' in window) {
            // https://developer.mozilla.org/en-US/docs/Web/API/Window/onbeforeinstallprompt
            window.addEventListener('beforeinstallprompt', e => {
                log('beforeinstallprompt has been fired');
                // Prevents immediate prompt display
                e.preventDefault();
                // https://developer.mozilla.org/en-US/docs/Web/API/BeforeInstallPromptEvent
                log('platforms ' + e.platforms.join(','));
                // Stash the event so it can be triggered later.
                deferredPrompt = e;
                // Update UI notify the user they can install the PWA
                install_button.style.display = 'block';
            });
        } else {
            log('onbeforeinstallprompt is not supported');
        }

        var install_button = document.getElementById('install_button');

        install_button.addEventListener('click', async (e) => {
            // https://developer.mozilla.org/en-US/docs/Web/API/BeforeInstallPromptEvent
            deferredPrompt.prompt();
            let result = await deferredPrompt.userChoice;
            if (result.outcome === 'accepted') {
                log('User accepted the install prompt');
            } else {
                log('User dismissed the install prompt');
            }
        });

        // https://developer.mozilla.org/en-US/docs/Web/API/Window/onappinstalled
        // Is dispatched once the web application is successfully installed
        if ('onappinstalled' in window) {
            window.addEventListener('appinstalled', e => {
                log('app is installed');
                install_button.style.display = 'none';
            });
        } else {
            log('onappinstalled is not supported');
        }

        window.addEventListener('load', () => {
            if (navigator.standalone) {
                log('Launched: Installed (iOS)');
            } else if (matchMedia('(display-mode: standalone)').matches) {
                log('Launched: Installed');
            } else {
                log('Launched: Browser Tab');
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then((reg) => {
                    log('SW registered!');
                    // self.addEventListener('install', event => {
                    // });
                    // self.addEventListener('activate', event => {
                    // });
                    // self.addEventListener('fetch', function (event) {
                    //     console.log('fetch', event.request.url);
                    // });                
                }).catch((error) => {
                    log('Boo!', error);
                });
        } else {
            log('serviceWorker is not supported');
        }

        // https://www.netguru.com/codestories/few-tips-that-will-make-your-pwa-on-ios-feel-like-native
        // Detects if device is on iOS 
        const isIos = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }

        log('isIos: ' + isIos());

        // Detects if device is in standalone mode
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
        log('isInStandaloneMode: ' + isInStandaloneMode());

        // Checks if should display install popup notification:
        if (isIos() && !isInStandaloneMode()) {
            document.getElementById('ios_call_to_action').style.display = 'block';
        }
    </script>

    <script>
        let myDedicatedWebWorker;

        document.getElementById('web_worker_create').addEventListener('click', e => {
            myDedicatedWebWorker = new Worker('dedicated-web-worker.js');
            // Receive message from web worker
            myDedicatedWebWorker.onmessage = function (e) {
                console.log('Receive message from dedicated web worker: ', e.data);
            };
            myDedicatedWebWorker.addEventListener("error", (e) => {
                console.log('error in web worker', e);
            });
        });

        document.getElementById('web_worker_send_message').addEventListener('click', e => {
            // Send message to web worker
            myDedicatedWebWorker.postMessage('Hello from index.html at ' + new Date().toLocaleTimeString());
        });

        document.getElementById('web_worker_throw_error').addEventListener('click', e => {
            myDedicatedWebWorker.postMessage('error');
        });

        // terminate web worker
        // Once a Worker is terminated you can't reuse or restart it
        document.getElementById('web_worker_terminate').addEventListener('click', e => {
            myDedicatedWebWorker.terminate();
        });

        // https://stackoverflow.com/questions/30500883/javascript-web-worker-close-vs-terminate
        // close web worker
        document.getElementById('web_worker_close').addEventListener('click', e => {
            myDedicatedWebWorker.postMessage('close');
        });

        //online
        console.log(navigator.onLine);
        window.addEventListener('offline', e => {
            console.log('online');
        });
        window.addEventListener('online', e => {
            console.log('offline');
        });
    </script>

    <script>
        let mySharedWebWorker;

        document.getElementById('shared_web_worker_create').addEventListener('click', e => {
            // https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker
            mySharedWebWorker = new SharedWorker("shared-web-worker.js");
            mySharedWebWorker.port.addEventListener("message", e => {
                console.log('Receive message from shared web worker: ', e.data);
            });
            mySharedWebWorker.port.start();
        });

        document.getElementById('shared_web_worker_send_message').addEventListener('click', e => {
            mySharedWebWorker.port.postMessage('Hello from index.html at ' + new Date().toLocaleTimeString())
        });
    </script>

    <script>
        function notifyMe() {
            if (!("Notification" in window)) {
                alert("This browser does not support desktop notification");
            }

            // Let's check whether notification permissions have already been granted
            else if (Notification.permission === "granted") {
                // If it's okay let's create a notification
                var notification = new Notification("Hi there!");
            }

            // Otherwise, we need to ask the user for permission
            else if (Notification.permission !== 'denied') {
                Notification.requestPermission(function (permission) {
                    // If the user accepts, let's create a notification
                    if (permission === "granted") {
                        var notification = new Notification("Hi there!");
                    }
                });
            }
        }

        function notifyMeWithSimpleCode() {
            Notification.requestPermission().then(function (result) {
                if (result === "granted") {
                    var notification = new Notification("Hi there with simple code!");
                }
            });
        }
    </script>

</body>

</html>